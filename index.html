<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Grower Management</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ---------- Base ---------- */
    :root{
      --bg1: #f5f8fb;
      --card: #ffffff;
      --accent: #0f9d58;
      --accent-dark: #0b7a43;
      --muted: #7b8694;
      --glass: rgba(255,255,255,0.6);
      --radius: 12px;
      --shadow: 0 8px 28px rgba(16,24,40,0.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, "Poppins", Arial, sans-serif;
      background: linear-gradient(180deg,#eef6ff 0%, #f7fbf9 100%);
      color:#222;
      -webkit-font-smoothing:antialiased;
    }
    .container{max-width:1100px;margin:28px auto;padding:20px}

    h1{margin:6px 0 18px;font-weight:600;color:#0b3d2e}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px}

    /* ---------- Form Card ---------- */
    .form-card{
      background:var(--card);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
      display:grid;
      gap:12px;
      grid-template-columns:1fr;
    }
    .form-grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
    }
    .input{
      position:relative;
    }
    .input input, .input textarea, .input select{
      width:100%;
      padding:12px 12px;
      border-radius:10px;
      border:1px solid #e2e8f0;
      background:#fbfdff;
      font-size:0.95rem;
      color:#111827;
      outline:none;
      transition:box-shadow .15s ease, border-color .12s ease, transform .12s;
    }
    .input input:focus, .input textarea:focus{
      box-shadow:0 6px 18px rgba(11,122,67,0.08);
      border-color:var(--accent);
    }
    .label{font-size:0.82rem;color:var(--muted);margin-bottom:6px;display:block}
    .small-msg{font-size:0.82rem;margin-top:6px;display:block}
    .small-msg.error{color:#d9534f}
    .small-msg.ok{color:var(--accent)}

    .actions{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:6px}

    button.btn{
      background:var(--accent);
      color:#fff;
      border:0;padding:10px 14px;border-radius:10px;
      box-shadow: 0 6px 18px rgba(11,122,67,0.14);
      cursor:pointer;font-weight:600;
    }
    button.btn.ghost{background:transparent;color:var(--accent);border:1px solid #e6f0ea;box-shadow:none}
    button.btn.warn{background:#e53e3e}
    .muted{color:var(--muted);font-size:0.9rem}

    /* ---------- Cards Grid ---------- */
    .grid{
      margin-top:22px;
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
      gap:18px;
    }

    .data-card{
      background:linear-gradient(180deg,#fff,#fbfffb);
      border-radius:12px;
      padding:14px;
      box-shadow:0 10px 30px rgba(15,23,42,0.06);
      border:1px solid rgba(10,10,10,0.02);
      display:flex;flex-direction:column;gap:8px;
    }
    .card-head{display:flex;align-items:center;justify-content:space-between}
    .card-title{font-weight:700;color:var(--accent-dark)}
    .card-sub{font-size:0.85rem;color:var(--muted)}
    .card-body p{margin:6px 0;font-size:0.92rem}
    .card-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}

    .pill{padding:6px 10px;border-radius:999px;font-size:0.85rem;background:#f4f8f5;color:var(--accent-dark);border:1px solid rgba(15,157,88,0.06)}
    .small-muted{font-size:0.78rem;color:var(--muted)}

    /* ---------- Modal ---------- */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(4,8,12,0.45);z-index:60}
    .modal.show{display:flex}
    .modal-card{width:100%;max-width:820px;background:white;border-radius:12px;padding:18px;box-shadow:0 40px 120px rgba(2,6,23,0.6)}
    .modal-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;max-height:70vh;overflow:auto}

    /* ---------- Print Styles (A4) ---------- */
    @media print{
      body *{visibility:hidden}
      #print-area, #print-area *{visibility:visible}
      #print-area{position:fixed;left:0;top:0;width:210mm;height:297mm;padding:24mm;background:white}
      .no-print{display:none!important}
      /* Add signature placeholders at bottom */
      .sign-row{position:absolute;bottom:36mm;left:24mm;right:24mm;display:flex;justify-content:space-between}
      .sign-box{text-align:center}
      .sign-line{border-top:1px solid #111;margin-top:36px;padding-top:6px}
      /* common diseases list style */
      .diseases{margin-top:10px;font-size:0.92rem}
    }

    /* Responsive small screens */
    @media (max-width:720px){
      .form-grid{grid-template-columns:1fr}
      .modal-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div>
        <h1>üçé Grower Management</h1>
        <div class="muted">Add, edit, delete, print and export grower entries</div>
      </div>
      <div>
        <button class="btn" id="refreshBtn">üîÑ Refresh</button>
      </div>
    </div>

    <!-- FORM -->
    <div class="form-card">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;flex-direction:column">
          <div class="label">Create New Grower Entry</div>
          <div class="small-muted">Fill required fields and submit</div>
        </div>
      </div>

      <div class="form-grid" id="formGrid">
        <div class="input">
          <label class="label">GR Number *</label>
          <input id="grNumber" name="grNumber" placeholder="Enter GR number" />
          <div id="grMsg" class="small-msg"></div>
        </div>

        <div class="input">
          <label class="label">Date *</label>
          <input id="date" type="date" name="date"/>
        </div>

        <div class="input">
          <label class="label">Ref / Main Party</label>
          <input id="refParty" name="refParty" />
        </div>

        <div class="input">
          <label class="label">Grower Name *</label>
          <input id="gname" name="gname" />
        </div>

        <div class="input">
          <label class="label">Phone No.</label>
          <input id="pno" name="pno" type="tel" />
        </div>

        <div class="input">
          <label class="label">Address</label>
          <input id="location" name="location" />
        </div>

        <div class="input">
          <label class="label">Challan Name</label>
          <input id="cname" name="cname" />
        </div>

        <div class="input">
          <label class="label">Challan No.</label>
          <input id="challanNo" name="challanNo" />
        </div>

        <div class="input">
          <label class="label">Khata</label>
          <input id="khata" name="khata" />
        </div>

        <div class="input">
          <label class="label">Apple Quantity (kg)</label>
          <input id="appleQuantity" name="appleQuantity" type="number" />
        </div>

        <div class="input">
          <label class="label">Driver Name</label>
          <input id="driverName" name="driverName" />
        </div>

        <div class="input">
          <label class="label">Vehicle No.</label>
          <input id="vehicleNumber" name="vehicleNumber" />
        </div>

        <div class="input">
          <label class="label">Driver Contact</label>
          <input id="dcontact" name="dcontact" />
        </div>

        <div class="input">
          <label class="label">Arrival Date/Time</label>
          <input id="arrivalTime" name="arrivalTime" type="datetime-local" />
        </div>

        <div class="input">
          <label class="label">Variety</label>
          <input id="variety" name="variety" />
        </div>

        <div class="input">
          <label class="label">Store Crates</label>
          <input id="storeCrates" name="storeCrates" />
        </div>

        <div class="input">
          <label class="label">Self Crates</label>
          <input id="selfCrates" name="selfCrates" />
        </div>

        <div class="input">
          <label class="label">Paties</label>
          <input id="paties" name="paties" />
        </div>

        <div class="input">
          <label class="label">Total Quantity</label>
          <input id="totalQuality" name="totalQuality" />
        </div>
      </div>

      <div class="actions">
        <button class="btn ghost" id="clearBtn" type="button">Clear</button>
        <button class="btn" id="submitBtn" type="button">Submit</button>
      </div>
    </div>

    <!-- GRID / Cards -->
    <div class="grid" id="cardsGrid" style="margin-top:18px"></div>

    <!-- Modal for Edit -->
    <div id="modal" class="modal no-print">
      <div class="modal-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Edit Entry</h3>
          <button class="btn ghost" id="closeModal">Close</button>
        </div>
        <div class="modal-grid" id="modalForm"></div>
        <div style="display:flex;justify-content:flex-end;margin-top:12px">
          <button class="btn" id="saveEdit">Save</button>
        </div>
      </div>
    </div>

    <!-- Hidden print area (populated on print/download) -->
    <div id="print-area" style="display:none"></div>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxDR_IqL_5dY0Q6tBqUhkXEE4Mux1l_JWz3e5JfJFLDlDjGcZ20ta9gBcsYLVSnnzId/exec"; // <<< REPLACE with Google Apps Script Web App URL
    const cardsGrid = document.getElementById('cardsGrid');
    const submitBtn = document.getElementById('submitBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const clearBtn = document.getElementById('clearBtn');

    const formFields = [
      'grNumber','date','refParty','gname','pno','location','cname','challanNo','khata','appleQuantity',
      'driverName','vehicleNumber','dcontact','arrivalTime','variety','storeCrates','selfCrates','paties','totalQuality'
    ];

    // simple helper to get form object
    function readForm() {
      const obj = {};
      formFields.forEach(f => {
        const el = document.getElementById(f);
        if (!el) return;
        obj[f] = el.value;
      });
      return obj;
    }
    function setForm(data) {
      formFields.forEach(f => {
        const el = document.getElementById(f);
        if (!el) return;
        // try header names as fallback
        el.value = data[f] !== undefined ? data[f] : (data[normalizeHeader(f)] !== undefined ? data[normalizeHeader(f)] : '');
      });
    }
    function clearForm(){
      formFields.forEach(f => { const el=document.getElementById(f); if(el) el.value=''; });
      document.getElementById('grMsg').textContent='';
      document.getElementById('grMsg').className='small-msg';
    }
    function normalizeHeader(h){
      return h.replace(/[^a-z0-9]+/gi,'_');
    }

    // throttle helper for live check
    function throttle(fn, wait){
      let t;
      return function(...args){
        clearTimeout(t);
        t = setTimeout(()=>fn(...args), wait);
      }
    }

    // Live GR validation on input (throttled, calls backend ?checkGr=)
    const grInput = document.getElementById('grNumber');
    const grMsg = document.getElementById('grMsg');
    async function checkGR(gr){
      if(!gr) { grMsg.textContent=''; return; }
      try {
        const res = await fetch(`${scriptURL}?checkGr=${encodeURIComponent(gr)}`);
        const j = await res.json();
        if (j.exists) {
          grMsg.textContent = '‚ùå GR already exists';
          grMsg.className = 'small-msg error';
        } else {
          grMsg.textContent = '‚úÖ GR available';
          grMsg.className = 'small-msg ok';
        }
      } catch(err){
        grMsg.textContent = '‚ö†Ô∏è Could not check GR';
        grMsg.className = 'small-msg';
      }
    }
    grInput.addEventListener('input', throttle(e => checkGR(e.target.value.trim()), 500));

    // Submit new entry
    submitBtn.addEventListener('click', async () => {
      const obj = readForm();
      if(!obj.grNumber){ alert('GR Number required'); return; }
      if(grMsg.textContent.includes('already exists')){ alert('GR exists ‚Äî choose another'); return; }

      // Add action
      obj.action = 'add';
      // arrivalTime normalization: if datetime-local present, use value otherwise blank
      try {
        const resp = await fetch(scriptURL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(obj)
        });
        const j = await resp.json();
        if(j.success){
          alert('‚úÖ Added');
          clearForm();
          loadAll();
        } else {
          alert('‚ùå '+(j.message||'Failed'));
        }
      } catch(err){
        alert('Network error: '+err.message);
      }
    });

    clearBtn.addEventListener('click', clearForm);
    refreshBtn.addEventListener('click', loadAll);

    // Load all and render cards
    async function loadAll(){
      cardsGrid.innerHTML = '<div class="muted">Loading...</div>';
      try {
        const res = await fetch(scriptURL);
        const data = await res.json();
        renderCards(data);
      } catch(err){
        cardsGrid.innerHTML = '<div class="muted">Failed to load data</div>';
      }
    }

    // RENDER CARD
    function renderCards(data){
      cardsGrid.innerHTML = '';
      if(!data || data.length === 0){
        cardsGrid.innerHTML = '<div class="muted">No entries found</div>'; return;
      }

      data.forEach(entry => {
        const card = document.createElement('div'); card.className='data-card';
        const head = document.createElement('div'); head.className='card-head';
        const title = document.createElement('div'); title.className='card-title';
        title.textContent = `GR: ${entry["GR No."] || entry["grNumber"] || ''}`;
        const sub = document.createElement('div'); sub.className='card-sub';
        sub.textContent = `${entry["Date"] || ''} ‚Ä¢ ${entry["Grower Name"] || ''}`;

        head.appendChild(title); head.appendChild(sub);

        const body = document.createElement('div'); body.className='card-body';
        // list key details
        const addLine = (label, val) => {
          const p = document.createElement('p');
          p.innerHTML = `<strong>${label}:</strong> ${val || ''}`;
          body.appendChild(p);
        };
        addLine('Ref Party', entry["Ref. / Main Party"]);
        addLine('Phone', entry["Phone No."]);
        addLine('Address', entry["Address"]);
        addLine('Apple Qty', entry["Apple Quantity"]);
        addLine('Challan', (entry["Challan Name"]||'') + ' / ' + (entry["Challan No."]||''));
        addLine('Driver', (entry["Driver Name"]||'') + ' ‚Ä¢ ' + (entry["Driver Contact"]||'') );
        addLine('Arrival', entry["Arival Time/ Date"] || entry["Arival Time/Date"] || entry["arrivalTime"]);

        const actions = document.createElement('div'); actions.className='card-actions';

        // Edit
        const editBtn = document.createElement('button'); editBtn.className='btn ghost';
        editBtn.textContent='Edit';
        editBtn.onclick = () => openEditModal(entry);

        // Delete
        const delBtn = document.createElement('button'); delBtn.className='btn warn';
        delBtn.textContent='Delete';
        delBtn.onclick = () => deleteEntry(entry);

        // Print
        const printBtn = document.createElement('button'); printBtn.className='btn';
        printBtn.textContent='Print';
        printBtn.onclick = () => printEntry(entry);

        // Download PDF (opens print dialog where user can Save as PDF)
        const pdfBtn = document.createElement('button'); pdfBtn.className='btn ghost';
        pdfBtn.textContent='Download PDF';
        pdfBtn.onclick = () => printEntry(entry); // same behavior

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        actions.appendChild(printBtn);
        actions.appendChild(pdfBtn);

        card.appendChild(head);
        card.appendChild(body);
        card.appendChild(actions);

        cardsGrid.appendChild(card);
      });
    }

    // Delete flow
    async function deleteEntry(entry){
      if(!confirm('Delete GR '+ (entry["GR No."]||entry.grNumber) + ' ?')) return;
      try {
        const payload = { action:'delete', grNumber: entry["GR No."]|| entry.grNumber };
        const res = await fetch(scriptURL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await res.json();
        if(j.success){ alert('Deleted'); loadAll(); }
        else alert('Delete failed: '+(j.message||''));
      } catch(err){ alert('Network error'); }
    }

    // Edit modal
    const modal = document.getElementById('modal');
    const modalForm = document.getElementById('modalForm');
    const closeModal = document.getElementById('closeModal');
    const saveEdit = document.getElementById('saveEdit');
    let currentEdit = null;

    closeModal.addEventListener('click', ()=> modal.classList.remove('show'));

    function openEditModal(entry){
      currentEdit = entry;
      modalForm.innerHTML = '';
      // Build inputs similar to form grid
      formFields.forEach(f => {
        const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.flexDirection='column';
        const lbl = document.createElement('label'); lbl.className='label'; lbl.textContent = f;
        const inp = document.createElement('input'); inp.style.padding='8px'; inp.style.borderRadius='6px';
        inp.value = entry[f] || entry[ prettifyKey(f) ] || '';
        inp.id = 'modal_'+f;
        wrap.appendChild(lbl); wrap.appendChild(inp);
        modalForm.appendChild(wrap);
      });
      modal.classList.add('show');
    }

    function prettifyKey(k){
      // attempt header mapping
      const map = {
        grNumber:'GR No.', date:'Date', refParty:'Ref. / Main Party', gname:'Grower Name', pno:'Phone No.',
        location:'Address', cname:'Challan Name', challanNo:'Challan No.', khata:'Khata',
        appleQuantity:'Apple Quantity', driverName:'Driver Name', vehicleNumber:'Vechile No.',
        dcontact:'Driver Contact', arrivalTime:'Arival Time/ Date', variety:'Verity', storeCrates:'Store Crates',
        selfCrates:'Self Crates', paties:'Paties', totalQuality:'Total Quantity'
      };
      return map[k] || k;
    }

    // Save edit
    saveEdit.addEventListener('click', async () => {
      if(!currentEdit) return;
      const payload = { action:'edit', grNumber: currentEdit["GR No."] || currentEdit.grNumber };
      formFields.forEach(f => {
        const v = document.getElementById('modal_'+f).value;
        payload[f] = v;
      });
      try {
        const res = await fetch(scriptURL, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        const j = await res.json();
        if(j.success){ alert('Saved'); modal.classList.remove('show'); loadAll(); }
        else alert('Save failed: '+(j.message||''));
      } catch(err){ alert('Network error'); }
    });

    // PRINT / PDF: build printable HTML and open print dialog (user can Save as PDF)
    function printEntry(entry){
      const printArea = document.getElementById('print-area');
      // Build print content: A4 friendly
      const html = `
        <div style="font-family:Arial, sans-serif;color:#111">
          <header style="text-align:center;margin-bottom:8px">
            <h2 style="margin:0">Grower Entry Report</h2>
            <p style="margin:0;font-size:0.95rem">GR No: ${entry["GR No."] || ''} &nbsp; | &nbsp; Date: ${entry["Date"] || ''}</p>
            <hr style="margin-top:8px;border:none;border-top:1px solid #ddd" />
          </header>

          <section>
            <h3 style="margin-bottom:6px">Grower Details</h3>
            <p><strong>Grower Name:</strong> ${entry["Grower Name"] || ''}</p>
            <p><strong>Ref / Main Party:</strong> ${entry["Ref. / Main Party"] || ''}</p>
            <p><strong>Phone:</strong> ${entry["Phone No."] || ''}</p>
            <p><strong>Address:</strong> ${entry["Address"] || ''}</p>
          </section>

          <section style="margin-top:10px">
            <h3 style="margin-bottom:6px">Delivery & Driver</h3>
            <p><strong>Challan:</strong> ${entry["Challan Name"]||''} / ${entry["Challan No."]||''}</p>
            <p><strong>Driver:</strong> ${entry["Driver Name"]||''} &nbsp; | &nbsp; <strong>Contact:</strong> ${entry["Driver Contact"]||''}</p>
            <p><strong>Vehicle No:</strong> ${entry["Vechile No."] || entry["Vehicle No."] || ''}</p>
            <p><strong>Arrival:</strong> ${entry["Arival Time/ Date"] || entry["Arival Time/Date"] || entry["arrivalTime"] || ''}</p>
          </section>

          <section style="margin-top:10px">
            <h3 style="margin-bottom:6px">Storage & Quantity</h3>
            <p><strong>Variety:</strong> ${entry["Verity"] || entry["Variety"] || ''}</p>
            <p><strong>Apple Quantity (kg):</strong> ${entry["Apple Quantity"] || ''}</p>
            <p><strong>Store Crates:</strong> ${entry["Store Crates"] || ''} &nbsp; <strong>Self Crates:</strong> ${entry["Self Crates"] || ''}</p>
            <p><strong>Total Quantity:</strong> ${entry["Total Quantity"] || ''}</p>
          </section>

          <section style="margin-top:12px">
            <h3 style="margin-bottom:6px">Common Diseases (for printing only)</h3>
            <ul class="diseases">
              <li>Scab (Venturia inaequalis)</li>
              <li>Powdery Mildew (Podosphaera leucotricha)</li>
              <li>Fire Blight (Erwinia amylovora)</li>
              <li>Bitter Pit (calcium deficiency)</li>
              <li>Storage Rots (Botrytis, Penicillium)</li>
            </ul>
          </section>

          <div class="sign-row">
            <div class="sign-box">
              <div class="sign-line">Driver Signature</div>
            </div>
            <div class="sign-box">
              <div class="sign-line">Authorized Signature</div>
            </div>
          </div>
        </div>
      `;
      printArea.innerHTML = html;
      printArea.style.display = 'block';
      // open print dialog
      setTimeout(()=>{ window.print(); printArea.style.display='none'; }, 300);
    }

    // Initial load
    loadAll();
  </script>
</body>
</html>
